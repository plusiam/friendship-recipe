<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹œêµ¬ì™€ í•¨ê»˜ ë§Œë“œëŠ” ìš°ì • ë ˆì‹œí”¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Dongle:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body { font-family: 'Pretendard', sans-serif; }
        .font-gowun { font-family: 'Gowun Dodum', sans-serif; }
        .font-dongle { font-family: 'Dongle', sans-serif; }
    </style>
</head>
<body class="bg-sky-50 flex items-center justify-center min-h-screen p-4 md:p-8">

    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-lg p-6 md:p-10 space-y-8">
        <div class="text-center">
            <h1 class="text-4xl font-bold text-sky-600 font-dongle">ì¹œêµ¬ì™€ í•¨ê»˜ ë§Œë“œëŠ” ìš°ì • ë ˆì‹œí”¼ ğŸ§‘â€ğŸ³</h1>
            <p class="text-gray-500 mt-2">ìš°ë¦¬ ìš°ì •ì„ ë” íŠ¹ë³„í•˜ê²Œ ë§Œë“¤ ìš”ë¦¬ë¥¼ ìƒìƒí•˜ë©° ì±„ì›Œë´ìš”!</p>
        </div>

        <form id="recipeForm" onsubmit="return false;" class="space-y-6">
            <div>
                <label for="recipe_name" class="text-lg font-semibold text-gray-700">ìš°ì • ë ˆì‹œí”¼ ì´ë¦„</label>
                <input type="text" id="recipe_name" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" placeholder="ì˜ˆ: ë¯¼ì¤€ì´ì™€ ë‚˜ì˜ ìš©ê¸° ìŠ¤ë¬´ë””">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="friend_name" class="text-lg font-semibold text-gray-700">ë°›ëŠ” ì¹œêµ¬ ì´ë¦„ (To.)</label>
                    <input type="text" id="friend_name" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" placeholder="ì˜ˆ: ê¹€ë¯¼ì¤€">
                </div>
                <div>
                    <label for="sender_name" class="text-lg font-semibold text-gray-700">ë³´ë‚´ëŠ” ì‚¬ëŒ ì´ë¦„ (From.)</label>
                    <input type="text" id="sender_name" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" placeholder="ì˜ˆ: ì´ì§€í˜œ">
                </div>
            </div>

            <div>
                <label class="text-lg font-semibold text-gray-700">ìš°ì •ì˜ í•µì‹¬ ì¬ë£Œ</label>
                <div id="ingredients-container" class="mt-2 space-y-2"></div>
                <button type="button" id="addIngredientBtn" class="mt-2 px-4 py-2 bg-yellow-400 text-yellow-800 font-semibold rounded-md hover:bg-yellow-500 transition text-sm">[+ ì¬ë£Œ ì¶”ê°€]</button>
            </div>

            <div>
                <label for="instructions" class="text-lg font-semibold text-gray-700">ë§Œë“œëŠ” ë°©ë²•</label>
                <textarea id="instructions" rows="5" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" placeholder="1. 'í•¨ê»˜ ì›ƒëŠ” ì‹œê°„'ê³¼ 'ë¯¿ëŠ” ë§ˆìŒ'ì„ ì˜ ì„ì–´ì¤ë‹ˆë‹¤.&#10;2. 'ê°€ë” ë‹¤íˆ¬ëŠ” ìˆœê°„'ì€ ì†”ì§í•˜ê²Œ ëŒ€í™”í•´ì„œ ë…¹ì—¬ì¤ë‹ˆë‹¤."></textarea>
            </div>
            
            <div>
                <label class="text-lg font-semibold text-gray-700">ğŸ–¼ï¸ ìš°ë¦¬ë§Œì˜ ì¶”ì–µ ì‚¬ì§„ ì²¨ë¶€í•˜ê¸°</label>
                <input type="file" id="imageUpload" accept="image/*" class="mt-2 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100"/>
                <div id="imagePreviewContainer" class="hidden mt-4">
                    <img id="imagePreview" src="#" alt="ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€" class="max-h-48 rounded-md shadow-md mx-auto"/>
                </div>
            </div>
            
            <div class="pt-8 text-center">
                <button type="button" id="generatePdfBtn" class="w-full md:w-auto px-8 py-4 bg-sky-500 text-white font-bold rounded-lg hover:bg-sky-600 transition-transform hover:scale-105 shadow-lg text-xl">ğŸ’Œ ì˜ˆìœ ìš°ì • ë ˆì‹œí”¼ ì¹´ë“œ ë§Œë“¤ê¸°</button>
            </div>
        </form>
    </div>

    <div id="recipeCard" class="font-gowun" style="position: absolute; left: -9999px; width: 560px; height: 400px; padding: 20px; background: linear-gradient(135deg, #fef7cd 0%, #e0f2fe 50%, #fce7f3 100%); border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
        <div class="h-full border-3 border-white border-dashed rounded-xl p-4 flex flex-col justify-between" style="background: rgba(255,255,255,0.3);">
            
            <div class="text-center">
                <h2 id="pdf_recipe_title" class="text-3xl font-dongle font-bold text-sky-700 mb-2 leading-tight"></h2>
                <div class="flex justify-between items-center text-lg text-gray-700 mb-3">
                    <span class="bg-pink-100 px-3 py-1 rounded-full text-sm">To. <span id="pdf_friend_name" class="font-bold text-pink-600"></span></span>
                    <span class="bg-blue-100 px-3 py-1 rounded-full text-sm">From. <span id="pdf_sender_name" class="font-bold text-blue-600"></span></span>
                </div>
            </div>
            
            <div class="flex-1 flex gap-4 overflow-hidden">
                <div class="flex-1 space-y-3">
                    <div class="bg-white/80 p-3 rounded-lg shadow-sm">
                        <h3 class="text-xl font-dongle font-bold text-yellow-600 mb-2 flex items-center"><span class="mr-1">â­</span> ìš°ì • ì¬ë£Œ</h3>
                        <ul id="pdf_ingredients_list" class="space-y-1 text-sm text-gray-700"></ul>
                    </div>
                    
                    <div id="pdfImageContainer" class="hidden bg-white/80 p-3 rounded-lg shadow-sm">
                        <h3 class="text-lg font-dongle font-bold text-pink-600 mb-2 flex items-center"><span class="mr-1">ğŸ“¸</span> ì¶”ì–µ</h3>
                        <img id="pdfImage" src="" class="rounded-md shadow-sm w-full h-20 object-cover"/>
                    </div>
                </div>
                
                <div class="flex-1">
                    <div class="bg-white/80 p-3 rounded-lg shadow-sm h-full">
                        <h3 class="text-xl font-dongle font-bold text-sky-600 mb-2 flex items-center"><span class="mr-1">ğŸ³</span> ë§Œë“œëŠ” ë°©ë²•</h3>
                        <p id="pdf_instructions" class="whitespace-pre-wrap text-gray-700 overflow-hidden text-sm leading-normal"></p>
                    </div>
                </div>
            </div>

            <div class="text-center mt-3">
                <div class="inline-flex items-center bg-white/60 px-4 py-2 rounded-full">
                    <span class="text-xs text-gray-500">ğŸ’ Made with Love on <span id="pdf_date"></span></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        const form = document.getElementById('recipeForm');
        const addIngredientBtn = document.getElementById('addIngredientBtn');
        const ingredientsContainer = document.getElementById('ingredients-container');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const generatePdfBtn = document.getElementById('generatePdfBtn');
        let uploadedImageSrc = '';

        window.onload = () => {
            generatePdfBtn.disabled = false;
            generatePdfBtn.innerHTML = 'ğŸ’Œ ì˜ˆìœ ìš°ì • ë ˆì‹œí”¼ ì¹´ë“œ ë§Œë“¤ê¸°';
        };
        
        generatePdfBtn.disabled = true;
        generatePdfBtn.innerHTML = 'ì¤€ë¹„ ì¤‘...';

        addIngredientBtn.addEventListener('click', () => {
            const ingredientDiv = document.createElement('div');
            ingredientDiv.className = 'flex items-center space-x-2';
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.className = 'ingredient-input flex-grow p-2.5 border border-gray-300 rounded-md focus:ring-yellow-500 focus:border-yellow-500';
            newInput.placeholder = 'ì¬ë£Œì™€ ì–‘ì„ ì ì–´ì£¼ì„¸ìš” (ì˜ˆ: ì›ƒìŒ 2ìŠ¤í‘¼)';
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.innerText = 'Ã—';
            removeBtn.className = 'px-2 py-1 bg-red-500 text-white rounded-full text-xs font-bold hover:bg-red-600 transition';
            removeBtn.onclick = () => ingredientDiv.remove();
            ingredientDiv.appendChild(newInput);
            ingredientDiv.appendChild(removeBtn);
            ingredientsContainer.appendChild(ingredientDiv);
        });

        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImageSrc = e.target.result;
                    imagePreview.src = uploadedImageSrc;
                    imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        generatePdfBtn.addEventListener('click', async () => {
            generatePdfBtn.innerText = 'ğŸ’ ì˜ˆìœ ì¹´ë“œ ë§Œë“œëŠ” ì¤‘...';
            generatePdfBtn.disabled = true;

            // ì¹´ë“œ ë°ì´í„° ì±„ìš°ê¸°
            document.getElementById('pdf_recipe_title').innerText = document.getElementById('recipe_name').value || 'ìš°ì • ë ˆì‹œí”¼';
            document.getElementById('pdf_friend_name').innerText = document.getElementById('friend_name').value || 'ì†Œì¤‘í•œ ì¹œêµ¬';
            document.getElementById('pdf_sender_name').innerText = document.getElementById('sender_name').value || 'ë„ˆì˜ ì¹œêµ¬';
            
            const instructionsText = document.getElementById('instructions').value || 'í•¨ê»˜ ë§›ìˆëŠ” ì¶”ì–µì„ ë§Œë“¤ì–´ìš”!';
            const instructionsP = document.getElementById('pdf_instructions');
            instructionsP.innerText = instructionsText;

            // [ê°œì„ ] ê¸€ì ìˆ˜ì— ë”°ë¼ í°íŠ¸ í¬ê¸° ìë™ ì¡°ì ˆ (ê¸€ì ë„˜ì¹¨ ë°©ì§€)
            const textLength = instructionsText.length;
            instructionsP.classList.remove('text-sm', 'text-xs', 'text-[10px]', 'leading-normal', 'leading-snug', 'leading-tight'); // ê¸°ì¡´ í´ë˜ìŠ¤ ì´ˆê¸°í™”
            if (textLength > 300) {
                instructionsP.classList.add('text-[10px]', 'leading-tight'); // ì•„ì£¼ ë§ì„ ë•Œ
            } else if (textLength > 180) {
                instructionsP.classList.add('text-xs', 'leading-normal'); // ë§ì„ ë•Œ
            } else {
                instructionsP.classList.add('text-sm', 'leading-snug'); // ë³´í†µ
            }

            const pdfIngredientsList = document.getElementById('pdf_ingredients_list');
            pdfIngredientsList.innerHTML = '';
            const ingredients = document.querySelectorAll('.ingredient-input');
            if (ingredients.length === 0 || Array.from(ingredients).every(input => !input.value.trim())) {
                ['ë¯¿ìŒ í•œ ì¤Œ', 'ì›ƒìŒ 2ìŠ¤í‘¼', 'ë°°ë ¤ ì ë‹¹íˆ', 'ì†Œí†µ ë“¬ë¿'].forEach(ingredient => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="text-yellow-500">â€¢</span> ${ingredient}`;
                    pdfIngredientsList.appendChild(li);
                });
            } else {
                ingredients.forEach(input => {
                    if (input.value.trim()) {
                        const li = document.createElement('li');
                        li.innerHTML = `<span class="text-yellow-500">â€¢</span> ${input.value}`;
                        pdfIngredientsList.appendChild(li);
                    }
                });
            }

            const pdfImage = document.getElementById('pdfImage');
            const pdfImageContainer = document.getElementById('pdfImageContainer');
            if (uploadedImageSrc) {
                pdfImage.src = uploadedImageSrc;
                pdfImageContainer.classList.remove('hidden');
            } else {
                pdfImageContainer.classList.add('hidden');
            }
            
            document.getElementById('pdf_date').innerText = new Date().toLocaleDateString('ko-KR');
            
            await new Promise(resolve => setTimeout(resolve, 500));

            const card = document.getElementById('recipeCard');
            const canvas = await html2canvas(card, { scale: 3, useCORS: true, logging: false, backgroundColor: null });
            const imgData = canvas.toDataURL('image/png');
            
            const doc = new jsPDF('l', 'mm', [148, 105]); // ê°€ë¡œí˜• ì—½ì„œ
            doc.addImage(imgData, 'PNG', 0, 0, 148, 105);
            doc.save('friendship_recipe_postcard.pdf');

            generatePdfBtn.innerHTML = 'ğŸ’Œ ì˜ˆìœ ìš°ì • ë ˆì‹œí”¼ ì¹´ë“œ ë§Œë“¤ê¸°';
            generatePdfBtn.disabled = false;
        });
    </script>
</body>
</html>
